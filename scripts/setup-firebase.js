#!/usr/bin/env node

/**
 * Firebase Setup Helper Script
 *
 * This script helps you configure Firebase for the BNomad admin panel.
 * Run: node scripts/setup-firebase.js
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  red: '\x1b[31m',
  cyan: '\x1b[36m',
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function question(prompt) {
  return new Promise((resolve) => {
    rl.question(`${colors.cyan}${prompt}${colors.reset}`, (answer) => {
      resolve(answer);
    });
  });
}

async function main() {
  log('\nüî• Firebase Setup Helper for BNomad Admin Panel\n', 'bright');

  log('This script will help you configure Firebase for your admin panel.', 'blue');
  log('Make sure you have:\n', 'blue');
  log('  1. Created a Firebase project at https://console.firebase.google.com', 'yellow');
  log('  2. Enabled Email/Password authentication', 'yellow');
  log('  3. Created a Firestore database', 'yellow');
  log('  4. Have your Firebase config values ready\n', 'yellow');

  const proceed = await question('Do you have these ready? (yes/no): ');

  if (proceed.toLowerCase() !== 'yes' && proceed.toLowerCase() !== 'y') {
    log('\nüìö Please follow the guide in FIREBASE_SETUP.md first!', 'yellow');
    log('Run: cat FIREBASE_SETUP.md\n', 'cyan');
    rl.close();
    return;
  }

  log('\n‚ú® Great! Let\'s configure your Firebase settings.\n', 'green');
  log('You can find these values in Firebase Console ‚Üí Project Settings ‚Üí General\n', 'blue');

  // Collect Firebase configuration
  const config = {
    apiKey: await question('Firebase API Key: '),
    authDomain: await question('Firebase Auth Domain (e.g., your-project.firebaseapp.com): '),
    projectId: await question('Firebase Project ID: '),
    storageBucket: await question('Firebase Storage Bucket (e.g., your-project.appspot.com): '),
    messagingSenderId: await question('Firebase Messaging Sender ID: '),
    appId: await question('Firebase App ID: '),
  };

  // Validate input
  if (!config.apiKey || !config.authDomain || !config.projectId) {
    log('\n‚ùå Error: API Key, Auth Domain, and Project ID are required!', 'red');
    rl.close();
    return;
  }

  // Create .env.local content
  const envContent = `# Firebase Client Configuration
# Generated by setup-firebase.js on ${new Date().toISOString()}
NEXT_PUBLIC_FIREBASE_API_KEY=${config.apiKey}
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${config.authDomain}
NEXT_PUBLIC_FIREBASE_PROJECT_ID=${config.projectId}
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${config.storageBucket}
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${config.messagingSenderId}
NEXT_PUBLIC_FIREBASE_APP_ID=${config.appId}

# Firebase Admin SDK (Server-side only) - OPTIONAL
# FIREBASE_PROJECT_ID=${config.projectId}
# FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@${config.projectId}.iam.gserviceaccount.com
# FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\\nYour private key here\\n-----END PRIVATE KEY-----\\n"
`;

  const envPath = path.join(process.cwd(), '.env.local');

  // Check if .env.local already exists
  if (fs.existsSync(envPath)) {
    log('\n‚ö†Ô∏è  .env.local already exists!', 'yellow');
    const overwrite = await question('Do you want to overwrite it? (yes/no): ');

    if (overwrite.toLowerCase() !== 'yes' && overwrite.toLowerCase() !== 'y') {
      log('\n‚úã Setup cancelled. Your existing .env.local was not modified.', 'yellow');
      rl.close();
      return;
    }

    // Backup existing file
    const backupPath = `${envPath}.backup.${Date.now()}`;
    fs.copyFileSync(envPath, backupPath);
    log(`\nüì¶ Backed up existing .env.local to: ${backupPath}`, 'blue');
  }

  // Write new .env.local
  fs.writeFileSync(envPath, envContent);
  log('\n‚úÖ Successfully created .env.local!', 'green');

  // Show next steps
  log('\nüìã Next Steps:\n', 'bright');
  log('1. Restart your development server:', 'yellow');
  log('   npm run dev\n', 'cyan');

  log('2. Create an admin user in Firebase Console:', 'yellow');
  log('   ‚Üí Go to https://console.firebase.google.com', 'cyan');
  log('   ‚Üí Select your project', 'cyan');
  log('   ‚Üí Authentication ‚Üí Users ‚Üí Add user', 'cyan');
  log('   ‚Üí Email: admin@bnomad.io (or your preferred email)', 'cyan');
  log('   ‚Üí Password: [choose a strong password]\n', 'cyan');

  log('3. Login to admin panel:', 'yellow');
  log('   ‚Üí Open: http://localhost:3000/en/admin/login', 'cyan');
  log('   ‚Üí Use the email and password you created\n', 'cyan');

  log('4. Set up Firestore security rules:', 'yellow');
  log('   ‚Üí Firebase Console ‚Üí Firestore Database ‚Üí Rules', 'cyan');
  log('   ‚Üí Copy rules from FIREBASE_SETUP.md\n', 'cyan');

  log('üéâ Firebase configuration complete!', 'green');
  log('üìö For detailed instructions, see: FIREBASE_SETUP.md\n', 'blue');

  rl.close();
}

main().catch((error) => {
  log(`\n‚ùå Error: ${error.message}`, 'red');
  rl.close();
  process.exit(1);
});
